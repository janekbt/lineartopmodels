---
title: "Linear top models"
subtitle: "A predictive model of house prices in King County, USA"
author: "Nicolas Carmona, Niklas Tillenburg, Janek Teders"
date: "December 16, 2018"
output: 
  ioslides_presentation:
    widescreen: true
---

```{r setup, include=FALSE}
#install.packages("kableExtra")
#install.packages("jpeg")
#install.packages("png")
#install.packages("kable")
#install.packages("gridExtra")
library(lubridate)
library(gridExtra)
library(MASS)
library(png)
library(jpeg)
library(tidyverse)
library(knitr)
library(car)
knitr::opts_chunk$set(echo = FALSE)
library(kableExtra)
options("kableExtra.html.bsTable" = T)
dat <- readRDS("dat_6.rds")
dat_old <- read_csv("kc_house_data.csv")
```

## The dataset

- Houses sold between May 2014 and May 2015
- Observations: **`r nrow(dat_old)`**
- Variables: **`r ncol(dat_old)`**

gonna add pic right here...

## Variables

```{r echo=FALSE}
matrix(colnames(dat_old), ncol = 3) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## Response variable inspection

```{r echo=FALSE}
par(mfrow = c(1,2))
truehist(dat_old$price,
         xlab = "price")
a <- qqPlot(dat_old$price,
            xlab = "quantiles",
            ylab = "")
```

## Response variable transformation

```{r echo=FALSE}
par(mfrow = c(1,2))
truehist(log10(dat_old$price),
         xlab = "price")
a <- qqPlot(log10(dat_old$price),
            xlab = "quantiles",
            ylab = "")
```

## How are we going to select the models?

* Problem: p-value and multiple testing
* Alternative criteria:
    + $AIC$
    + $BIC$
    + $R^2_{adj.}$

## Preliminary data formating

**Changes**:

  - **square feet** into **square meters**
  - waterfront and renovated into a **factor** variable
  - log10 of price (response variable)


```{r}
dat_old_1 <- dat_old %>%
  mutate_at(
    vars(starts_with("sqft")),
    function(x) x * 0.092903
  ) %>%
  rename_at(
    vars(starts_with("sqft")),
    function(x) str_replace(x, "sqft", "sqm")
  ) %>%
  mutate(
    waterfront = factor(waterfront),
    price = log10(price),
    renovated = factor(ifelse(yr_renovated > 0, "yes", "no"))
    ) %>%
  dplyr::select(-id)

lmo_1 <- lm(price ~ . -date, data = dat_old_1)

result_1 <- summary(lmo_1)

```

## First model {.flexbox .vcenter}

<div class="columns-2">

```{r}
knitr::include_graphics("screenshots/summary_2.png")
```

```{r include=FALSE}
a <- round(result_1$adj.r.squared, 4)
b <- round(AIC(lmo_1), 4)
c <- round(BIC(lmo_1), 4)
```


**Criteria:**

  - $R^2_{adj}$: `r a`
  - $AIC$: `r b`
  - $BIC$: `r c`
</div>

## Outliers

```{r echo=FALSE, fig.align = "center"}
plot(lmo_1, which=5)
```

## Track outliers down

```{r, fig.align = "center"}
boxplot(dat_old_1$bedrooms, horizontal = T, main = "bedrooms")
```

- Additionally, testing with removal of observations with zero bedrooms. 

## Post outlier removal comparison

```{r warning=FALSE}
lmo_excluding_33 <- dat_old_1 %>%
  filter(bedrooms < 15) %>%
  lm(data = . , price ~ . -date)

lmo_excluding_outlier <- dat_old_1 %>%
  filter(bedrooms < 15 & bedrooms > 0) %>%
  lm(data = ., price ~ . -date)

AIC(lmo_1, lmo_excluding_33, lmo_excluding_outlier) %>%
  kable() %>%
  kable_styling()

```

* Observations:
    + Dropping extreme outlier slightly improves the model
    + Dropping zero-valued observations adds no value to the model


## Creating new variables

* Average price by zipcode
    + sampling 20% of the data
    + computing average price by zipcode
    + adding computed averages to remaining 80%
      
* Date related columns
    + creating weeks and months of the year

```{r include=FALSE}
dat_old_2 <- dat_old_1 %>%
  mutate_at(
    vars(starts_with("sqft")),
    function(x) x * 0.092903
  ) %>%
  rename_at(
    vars(starts_with("sqft")),
    function(x) str_replace(x, "sqft", "sqm")
  ) %>%
  mutate(
    week_of_year = week(date),
    month_of_year = month(date)
  ) %>%
  dplyr::select(-starts_with("sqm"), starts_with("sqm"), -date)




set.seed(1234)
dat_old_2_shuffled<- dat_old_2 %>%
  sample_n(nrow(.))

first_fifth_avg <- dat_old_2_shuffled %>%
  slice(1:(n()/5)) %>%
  group_by(zipcode) %>%
  summarise(mean_price_zip = mean(price))

result <- dat_old_2_shuffled %>%
  slice((n()/5):n()) %>%
  left_join(., first_fifth_avg, key = zipcode)

```



## Variable preselection (Part I)

### Correlation analysis 

```{r echo=FALSE, warning=FALSE}
corrs <- result %>%
   dplyr::select(-waterfront, -renovated) %>%
  cor(.) %>%
  .[,1] %>%
  abs(.) %>%
  sort(.) %>%
  as.matrix(., nrow(length(.)))

good_corr <- corrs %>%
  rownames(.) %>%
  .[10:length(.)]

corrs_names = rownames(corrs)
corrs = cbind(corrs_names, round(corrs, 4))
rownames(corrs) = NULL
colnames(corrs) = NULL

cbind(corrs[1:7,], corrs[8:14,], corrs[15:21,]) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```
## Variable preselection 

* Cutoff:
    + We observe a big jump from 0.107 to 0.314
    + Dropping all variables below 0.314
    + We are now left with 11 variables (plus the 2 factors)




## Second model

```{r}

dat_new_1 <- result %>%
  dplyr::select(one_of(good_corr), renovated, waterfront)

lmo_2 <- lm(price ~ ., data = dat_new_1)

s_lmo_2 <- summary(lmo_2)
```


<div class="columns-2">

**Old model:**

  - $R^2_{adj}$: `r round(result_1$adj.r.squared, 4)`
  - $AIC$: `r round(AIC(lmo_1), 4)`
  - $BIC$: `r round(BIC(lmo_1), 4)`

\newline
\newline
\newline
\newline
\newline

**Second model:**

  - $R^2_{adj}$: `r round(s_lmo_2$adj.r.squared, 4)`
  - $AIC$: `r round(AIC(lmo_2), 4)`
  - $BIC$: `r round(BIC(lmo_2), 4)`
  
</div>

## Variable preselection (Part II)

- **sqm_living** is a linear combination of **sqm_basement** and **sqm_above**.

```{r}
lmo_AB <- dat_new_1 %>%
  dplyr::select(one_of(good_corr), -sqm_living) %>%
  lm(data = ., price ~ .)

lmo_L <- dat_new_1 %>%
  dplyr::select(one_of(good_corr), -sqm_above, -sqm_basement) %>%
  lm(data = ., price ~ .)

s_lmo_AB <- summary(lmo_AB)
s_lmo_L <- summary(lmo_L)

row_names <- c("Model with sqm_above & sqm_basement", "Model with sqm_living")
col_names <- c("R^2 adjust.", "AIC", "BIC")
a <- matrix(c(round(s_lmo_AB$adj.r.squared, 4),
              round(AIC(lmo_AB), 4),
              round(BIC(lmo_AB), 4),
              round(s_lmo_L$adj.r.squared, 4),
              round(AIC(lmo_L), 4),
              round(BIC(lmo_L), 4)),
            ncol = 3,
            byrow = T,
            dimnames = list(row_names, col_names))
a %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```




























